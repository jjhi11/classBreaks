<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!--
     ArcGIS API for JavaScript, https://js.arcgis.com
     For more information about the visualization-sm-classbreaks sample,
     read the original sample description at developers.arcgis.com.
     https://developers.arcgis.com/javascript/latest/sample-code/visualization-sm-classbreaks/
     -->
    <title>
      Generate a class breaks visualization | Sample | ArcGIS API for JavaScript
      4.20
    </title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.20/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.20/"></script>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@esri/calcite-components/dist/calcite/calcite.css" />
    <script type="module" src="https://unpkg.com/@esri/calcite-components/dist/calcite/calcite.esm.js"></script>
    <script nomodule="" src="https://unpkg.com/@esri/calcite-components/dist/calcite/calcite.js"></script>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #infoDiv {
        padding: 8px;
      }
    </style>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/smartMapping/renderers/color",
        "esri/smartMapping/statistics/histogram",
        "esri/widgets/smartMapping/ClassedColorSlider",
        "esri/widgets/Legend",
        "esri/widgets/BasemapToggle",
        "esri/core/watchUtils"
      ], function (
        Map,
        MapView,
        FeatureLayer,
        colorRendererCreator,
        histogram,
        ClassedColorSlider,
        Legend,
        BasemapToggle,
        watchUtils
      ) {
        let fieldSelect, classSelect, numClassesInput, slider, layerChoice;

        const layer = new FeatureLayer({
          title: "Utah Wetlands",
          url:
            "https://services.arcgis.com/ZzrwjTRez6FJiOq4/arcgis/rest/services/VisualizePropertiesHUCs/FeatureServer",
          popupTemplate: {
            // autocast as esri/PopupTemplate
            title: "Poop",
            content: [
              {
                type: "fields",
                fieldInfos: [
                  {
                    fieldName: "utah_percent",
                    label: "Area in Utah (%)",
                    format: {
                      digitSeparator: true,
                      places: 0
                    }
                  },
                  {
                    fieldName: "outdated_mapping_percent",
                    label: "Outdated Wetland Mapping (%)",
                    format: {
                      digitSeparator: true,
                      places: 0
                    }
                  },
                  {
                    fieldName: "hr2000s_mapping_percent",
                    label: "Wetland Mapping 2000-2009 (%)",
                    format: {
                      digitSeparator: true,
                      places: 0
                    }
                  },
                  {
                    fieldName: "hr2010s_mapping_percent",
                    label: "Wetland Mapping 2010-2019 (%)",
                    format: {
                      digitSeparator: true,
                      places: 0
                    }
                  },
                  {
                    fieldName: "riverine_count",
                    label: "Rivers, Channels, and Bars (#)",
                    format: {
                      digitSeparator: true,
                      places: 0
                    }
                  }
                ]
              }
            ]
          },
        });

        const layerTest = new FeatureLayer({
          title: "Percent Mapped in Utah",
          url: "https://services.arcgis.com/ZzrwjTRez6FJiOq4/ArcGIS/rest/services/VisualizePropertiesHUCs/FeatureServer/0",
          //visible: false
        })

        const map = new Map({
          basemap: "gray-vector"
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-111, 40],
          zoom: 7
        });

        // Set up UI elements

        view.ui.add(
          new Legend({
            view: view
          }),
          "bottom-left"
        );

        const basemapToggle = new BasemapToggle({
          view: view,
          nextBasemap: "national-geographic"
        });
        view.ui.add(basemapToggle, "bottom-right");
        basemapToggle.on("toggle", generateRenderer);

        view.ui.add("infoDiv", "top-right");

        // Generate a new renderer each time the user changes an input parameter
        view.when().then(function () {
          fieldSelect = document.getElementById("field-select");
          fieldSelect.addEventListener("calciteDropdownSelect", generateRenderer);


          watchUtils.whenFalseOnce(view, "updating", generateRenderer);
        });
        //map.add(layerTest);

        //console.log(layerTest);

        // Generate rounded arcade expression when user
        // selects a field name
        function getValueExpression(field) {
          console.log(field);
          return "Round( ( $feature." + field + " / 100 ) * 100, 1)";
        }

        function generateRenderer() {
          const fieldLabel =
            fieldSelect.selectedItems[0].innerText;
          fieldValue =
            fieldSelect.selectedItems[0].id;
          
          console.info("change: ", fieldLabel)
          console.info("value: ", fieldValue)

          if (map.layers.includes(layerChoice)) {
          map.remove(layerChoice);
          }
          destroySlider();

          if (fieldValue == "utah_percent") {
            layerChoice = new FeatureLayer({
              url: "https://services.arcgis.com/ZzrwjTRez6FJiOq4/ArcGIS/rest/services/VisualizePropertiesHUCs/FeatureServer/0",
              title: "Area in Utah (%)",
            });

          } else if (fieldValue == "outdated_mapping_percent") {
            layerChoice = new FeatureLayer({
              url: "https://services.arcgis.com/ZzrwjTRez6FJiOq4/ArcGIS/rest/services/VisualizePropertiesHUCs/FeatureServer/1",
              title: "Outdated Wetland Mapping (%)",
          });
          } else if (fieldValue == "hr2000s_mapping_percent") {
            layerChoice = new FeatureLayer({
              url: "https://services.arcgis.com/ZzrwjTRez6FJiOq4/ArcGIS/rest/services/VisualizePropertiesHUCs/FeatureServer/2",
              title: "Wetland Mapping 2000-2009 (%)",
          });
          } else if (fieldValue == "hr2010s_mapping_percent") {
            layerChoice = new FeatureLayer({
              url: "https://services.arcgis.com/ZzrwjTRez6FJiOq4/ArcGIS/rest/services/VisualizePropertiesHUCs/FeatureServer/3",
              title: "Wetland Mapping 2010-2019 (%)",
          });
          } else if (fieldValue == "riverine_count") {
            layerChoice = new FeatureLayer({
              url: "https://services.arcgis.com/ZzrwjTRez6FJiOq4/ArcGIS/rest/services/VisualizePropertiesHUCs/FeatureServer/4",
              title: "Rivers, Channels, and Bars (#)",
          });
          }


          

          map.add(layerChoice);
          

    //       const params = {
    //         layer: layerChoice,
    //         field: fieldValue,
    //         //valueExpression: getValueExpression(fieldValue),
    //         view: view,
    //         // classificationMethod: classificationMethod,
    //         // numClasses: parseInt(numClassesInput.value),
    //         classificationMethod: "esriClassifyManual",

    // classBreakInfos: [
    //   {
    //     symbol: {
    //       type: "esriSFS",
    //       style: "esriSFSSolid",
    //       color: [
    //         102,
    //         37,
    //         6,
    //         255
    //       ],
    //       outline: {
    //         type: "esriSLS",
    //         style: "esriSLSSolid",
    //         color: [
    //           110,
    //           110,
    //           110,
    //           255
    //         ],
    //         width: 0.7
    //       }
    //     },
    //     minValue: 0,
    //     maxValue: 0,
    //     label: "0"
    //   },
    //   {
    //     symbol: {
    //       type: "esriSFS",
    //       style: "esriSFSSolid",
    //       color: [
    //         204,
    //         76,
    //         2,
    //         255
    //       ],
    //       outline: {
    //         type: "esriSLS",
    //         style: "esriSLSSolid",
    //         color: [
    //           110,
    //           110,
    //           110,
    //           255
    //         ],
    //         width: 0.7
    //       }
    //     },
    //     minValue: 0.1,
    //     maxValue: 25,
    //     label: ">0-25"
    //   },
    //   {
    //     symbol: {
    //       type: "esriSFS",
    //       style: "esriSFSSolid",
    //       color: [
    //         254,
    //         153,
    //         41,
    //         255
    //       ],
    //       outline: {
    //         type: "esriSLS",
    //         style: "esriSLSSolid",
    //         color: [
    //           110,
    //           110,
    //           110,
    //           255
    //         ],
    //       width: 0.7
    //       }
    //     },
    //     minValue: 25.1,
    //     maxValue: 50,
    //     label: ">25-50"
    //   },
    //   {
    //     symbol: {
    //       type: "esriSFS",
    //       style: "esriSFSSolid",
    //       color: [
    //         254,
    //         227,
    //         145,
    //         255
    //       ],
    //       outline: {
    //         type: "esriSLS",
    //         style: "esriSLSSolid",
    //         color: [
    //           110,
    //           110,
    //           110,
    //           255
    //         ],
    //         width: 0.7
    //       }
    //     },
    //     minValue: 50.1,
    //     maxValue: 75,
    //     label: ">50-75"
    //   },
    //   {
    //     symbol: {
    //       type: "esriSFS",
    //       style: "esriSFSSolid",
    //       color: [
    //         255,
    //         255,
    //         229,
    //         255
    //       ],
    //       outline: {
    //         type: "esriSLS",
    //         style: "esriSLSSolid",
    //         color: [
    //           110,
    //           110,
    //           110,
    //           255
    //         ],
    //         width: 0.7
    //       }
    //     },
    //     minValue: 75.1,
    //     maxValue: 100,
    //     label: ">75-100"
    //   }
    // ],
    //         legendOptions: {
    //           title: "Poop",
    //           order: "ascendingValues"
    //         }
    //       };

          // generate the renderer and set it on the layer
          // colorRendererCreator
          //   .createClassBreaksRenderer(params)
          //   .then(function (rendererResponse) {
          //     console.log(rendererResponse.renderer);
          //     console.log(layerChoice.renderer);
          //     layerChoice.renderer = rendererResponse.renderer;
          //     console.log(layerChoice.renderer);

          //     if (!map.layers.includes(layerChoice)) {
          //       map.add(layerChoice);
          //     }
          //       destroySlider();
          //   });
        }



        function destroySlider() {
          if (slider) {
            let container = document.getElementById("containerDiv");
            view.ui.remove(container);
            slider.container = null;
            slider = null;
            container = null;
          }
        }
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div id="infoDiv" class="esri-widget">
      <calcite-dropdown id="field-select">
        <calcite-button slot="dropdown-trigger">Select Field</calcite-button>
        <calcite-dropdown-group id="group-1" selection-mode="single">
          <calcite-dropdown-item id="utah_percent" active>Mapped in Utah %</calcite-dropdown-item>
          <calcite-dropdown-item id="outdated_mapping_percent">Outdated Mapping %</calcite-dropdown-item>
          <calcite-dropdown-item id="hr2000s_mapping_percent">2000s Mapping %</calcite-dropdown-item>
          <calcite-dropdown-item id="hr2010s_mapping_percent">2010s Mapping %</calcite-dropdown-item>
          <calcite-dropdown-item id="riverine_count">Riverine Count</calcite-dropdown-item>
        </calcite-dropdown-group>
      </calcite-dropdown>


    </div>
  </body>
</html>
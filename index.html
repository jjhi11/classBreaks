<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <!--
     ArcGIS API for JavaScript, https://js.arcgis.com
     For more information about the visualization-sm-classbreaks sample,
     read the original sample description at developers.arcgis.com.
     https://developers.arcgis.com/javascript/latest/sample-code/visualization-sm-classbreaks/
     -->
    <title>
      Generate a class breaks visualization | Sample | ArcGIS API for JavaScript
      4.20
    </title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.20/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.20/"></script>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/@esri/calcite-components/dist/calcite/calcite.css" />
    <script type="module" src="https://unpkg.com/@esri/calcite-components/dist/calcite/calcite.esm.js"></script>
    <script nomodule="" src="https://unpkg.com/@esri/calcite-components/dist/calcite/calcite.js"></script>

    <style>
      html,
      body,
      #viewDiv {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #infoDiv {
        padding: 8px;
      }
    </style>

    <script>
      require([
        "esri/Map",
        "esri/views/MapView",
        "esri/layers/FeatureLayer",
        "esri/smartMapping/renderers/color",
        "esri/smartMapping/statistics/histogram",
        "esri/widgets/smartMapping/ClassedColorSlider",
        "esri/widgets/Legend",
        "esri/widgets/BasemapToggle",
        "esri/core/watchUtils"
      ], function (
        Map,
        MapView,
        FeatureLayer,
        colorRendererCreator,
        histogram,
        ClassedColorSlider,
        Legend,
        BasemapToggle,
        watchUtils
      ) {
        let layerSelect, fieldSelect, classSelect, numClassesInput, slider;

        const layer = new FeatureLayer({
          title: "Utah Wetlands",
          url:
            "https://webmaps.geology.utah.gov/arcgis/rest/services/Wetlands/Wetland_Landscape_Data/MapServer/0",
          popupTemplate: {
            // autocast as esri/PopupTemplate
            title: "HUC12",
            content: [
              {
                type: "fields",
                fieldInfos: [
                  {
                    fieldName: "utah_percent",
                    label: "Arear in Utah (%)",
                    format: {
                      digitSeparator: true,
                      places: 0
                    }
                  },
                  {
                    fieldName: "outdated_mapping_percent",
                    label: "Outdated Wetland Mapping (%)",
                    format: {
                      digitSeparator: true,
                      places: 0
                    }
                  },
                  {
                    fieldName: "hr2000s_mapping_percent",
                    label: "Wetland Mapping 2000-2009 (%)",
                    format: {
                      digitSeparator: true,
                      places: 0
                    }
                  },
                  {
                    fieldName: "hr2010s_mapping_percent",
                    label: "Wetland Mapping 2010-2019 (%)",
                    format: {
                      digitSeparator: true,
                      places: 0
                    }
                  },
                  {
                    fieldName: "riverine_count",
                    label: "Rivers, Channels, and Bars (#)",
                    format: {
                      digitSeparator: true,
                      places: 0
                    }
                  }
                ]
              }
            ]
          },
        });

        const map = new Map({
          basemap: "gray-vector"
        });

        const view = new MapView({
          container: "viewDiv",
          map: map,
          center: [-111, 40],
          zoom: 7
        });

        // Set up UI elements

        view.ui.add(
          new Legend({
            view: view
          }),
          "bottom-left"
        );

        const basemapToggle = new BasemapToggle({
          view: view,
          nextBasemap: "national-geographic"
        });
        view.ui.add(basemapToggle, "bottom-right");
        basemapToggle.on("toggle", generateRenderer);

        view.ui.add("infoDiv", "top-right");

        // Generate a new renderer each time the user changes an input parameter
        view.when().then(function () {

          layerSelect = document.getElementById("layer-select");
          layerSelect.addEventListener("calciteDropdownSelect", generateRenderer);

          fieldSelect = document.getElementById("field-select");
          fieldSelect.addEventListener("calciteDropdownSelect", generateRenderer);

          classSelect = document.getElementById("class-select");
          classSelect.addEventListener("change", generateRenderer);

          numClassesInput = document.getElementById("num-classes");
          numClassesInput.addEventListener("change", generateRenderer);

          watchUtils.whenFalseOnce(view, "updating", generateRenderer);
        });

        // Generate rounded arcade expression when user
        // selects a field name
        function getValueExpression(field) {
          console.log(field);
          return "Round( ( $feature." + field + " / 100 ) * 100, 1)";
        }

        function generateRenderer() {
          console.log(fieldSelect);
          console.log(layerSelect);
          const layerLabel = 
            layerSelect.selectedItems[0].innerText;
          const layerValue = 
            layerSelect.selectedItems[0].id;
          //grab values from element for field choice
          const fieldLabel =
            fieldSelect.selectedItems[0].innerText;
          const fieldValue =
            fieldSelect.selectedItems[0].id;

          console.info("change: ", layerLabel)
          console.info("value: ", layerValue)

          console.info("change: ", fieldLabel)
          console.info("value: ", fieldValue)
          
          // default to natural-breaks when manual is selected for classification method
          const classificationMethod =
            classSelect.value === "manual"
              ? "natural-breaks"
              : classSelect.value;

          const params = {
            layer: layer,
            //valueExpression: getValueExpression(fieldValue),
            field: fieldValue,
            view: view,
            classificationMethod: classificationMethod,
            numClasses: parseInt(numClassesInput.value),
            legendOptions: {
              title: fieldLabel
            }
          };

          // generate the renderer and set it on the layer
          colorRendererCreator
            .createClassBreaksRenderer(params)
            .then(function (rendererResponse) {
              layer.renderer = rendererResponse.renderer;

              if (!map.layers.includes(layer)) {
                map.add(layer);
              }

              if (classSelect.value === "manual") {
                // if manual is selected, then add or update
                // a classed color slider to allow the user to
                // construct manual class breaks
                updateColorSlider(rendererResponse);
              } else {
                destroySlider();
              }
            });
        }

        // If manual classification method is selected, then create
        // a classed color slider to allow user to manually modify
        // the class breaks starting with the generated renderer

        function updateColorSlider(rendererResult) {
          const fieldValue =
            fieldSelect.selectedItems[0].id;
          histogram({
            layer: layer,
            //valueExpression: getValueExpression(fieldValue),
            field: fieldValue,
            view: view,
            numBins: 100
          }).then(function (histogramResult) {
            if (!slider) {
              const sliderContainer = document.createElement("div");
              const container = document.createElement("div");
              container.id = "containerDiv";
              container.appendChild(sliderContainer);
              view.ui.add(container, "top-right");

              slider = ClassedColorSlider.fromRendererResult(
                rendererResult,
                histogramResult
              );
              slider.container = container;
              slider.viewModel.precision = 1;

              function changeEventHandler() {
                const renderer = layer.renderer.clone();
                renderer.classBreakInfos = slider.updateClassBreakInfos(
                  renderer.classBreakInfos
                );
                layer.renderer = renderer;
              }

              slider.on(
                ["thumb-change", "thumb-drag", "min-change", "max-change"],
                changeEventHandler
              );
            } else {
              slider.updateFromRendererResult(rendererResult, histogramResult);
            }
          });
        }

        function destroySlider() {
          if (slider) {
            let container = document.getElementById("containerDiv");
            view.ui.remove(container);
            slider.container = null;
            slider = null;
            container = null;
          }
        }
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
    <div id="infoDiv" class="esri-widget">

      <calcite-dropdown id="layer-select">
        <calcite-button slot="dropdown-trigger">Select Layer</calcite-button>
        <calcite-dropdown-group id="group-2" selection-mode="single">
          <calcite-dropdown-item id="huc12" active>HUC12</calcite-dropdown-item>
          <calcite-dropdown-item id="huc12eco">HUC12 by Ecoregion</calcite-dropdown-item>
          <calcite-dropdown-item id="huc8">HUC8</calcite-dropdown-item>
          <calcite-dropdown-item id="huc8eco">HUC8 by Ecoregion</calcite-dropdown-item>
          <calcite-dropdown-item id="ecoregion">Ecoregion</calcite-dropdown-item>
        </calcite-dropdown-group>
      </calcite-dropdown>

      <calcite-dropdown id="field-select">
        <calcite-button slot="dropdown-trigger">Select Field</calcite-button>
        <calcite-dropdown-group id="group-1" selection-mode="single">
          <calcite-dropdown-item id="utah_percent" active>Area in Utah (%)</calcite-dropdown-item>
          <calcite-dropdown-item id="outdated_mapping_percent">Outdated Wetland Mapping (%)</calcite-dropdown-item>
          <calcite-dropdown-item id="hr2000s_mapping_percent">Wetland Mapping 2000-2009 (%)</calcite-dropdown-item>
          <calcite-dropdown-item id="hr2010s_mapping_percent">Wetland Mapping 2010-2019 (%)</calcite-dropdown-item>
          <calcite-dropdown-item id="riverine_count">Rivers, Channels, and Bars (#)</calcite-dropdown-item>
        </calcite-dropdown-group>
      </calcite-dropdown>

      Classification:
      <select id="class-select" class="esri-widget">
        <option value="equal-interval" selected>Equal interval</option>
        <option value="quantile">Quantile</option>
        <option value="natural-breaks">Natual Breaks</option>
        <option value="manual">Manual</option>
      </select>
      Breaks:
      <input
        type="number"
        id="num-classes"
        class="esri-widget"
        value="5"
        min="2"
        max="10"
      />
    </div>
  </body>
</html>